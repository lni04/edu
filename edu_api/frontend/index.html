<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>教务管理系统</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
    
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .login-box { background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); width: 360px; }
    .login-box h2 { text-align: center; margin-bottom: 30px; color: #333; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 6px; color: #666; font-size: 14px; }
    .form-group input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: #1890ff; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: #1890ff; color: #fff; }
    .btn-primary:hover { background: #40a9ff; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .error-msg { color: #ff4d4f; font-size: 13px; margin-top: 10px; text-align: center; }
    .debug-msg { color: #666; font-size: 12px; margin-top: 10px; text-align: center; word-break: break-all; }
    
    .main-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #001529; padding-top: 20px; position: relative; }
    .sidebar h3 { color: #fff; text-align: center; padding: 20px 0; font-size: 18px; border-bottom: 1px solid #0d2137; }
    .nav-menu { list-style: none; margin-top: 10px; }
    .nav-menu li { padding: 14px 24px; color: #ffffffa6; cursor: pointer; transition: all 0.3s; font-size: 14px; }
    .nav-menu li:hover { background: #0d2137; color: #fff; }
    .nav-menu li.active { background: #1890ff; color: #fff; }
    .logout-btn { position: absolute; bottom: 20px; left: 20px; color: #ffffffa6; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { color: #ff4d4f; }
    
    .content { flex: 1; padding: 24px; }
    .content-header { background: #fff; padding: 16px 24px; border-radius: 4px; margin-bottom: 16px; }
    .content-header h2 { font-size: 18px; color: #333; }
    .content-body { background: #fff; padding: 24px; border-radius: 4px; }
    
    .profile-card { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .profile-item { padding: 16px; background: #fafafa; border-radius: 4px; }
    .profile-item label { display: block; color: #999; font-size: 13px; margin-bottom: 6px; }
    .profile-item span { font-size: 16px; color: #333; font-weight: 500; }
    .profile-item.highlight { background: #e6f7ff; }
    .profile-item.highlight span { color: #1890ff; font-size: 24px; }
    
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    .data-table th { background: #fafafa; color: #666; font-weight: 500; }
    .data-table tr:hover { background: #fafafa; }
    .semester-group { margin-bottom: 24px; }
    .semester-title { font-size: 16px; color: #1890ff; margin-bottom: 12px; padding-left: 10px; border-left: 3px solid #1890ff; }
    
    .gpa-summary { display: flex; gap: 20px; margin-bottom: 24px; }
    .gpa-card { flex: 1; padding: 24px; background: linear-gradient(135deg, #1890ff 0%, #36cfc9 100%); border-radius: 8px; color: #fff; }
    .gpa-card h4 { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
    .gpa-card .value { font-size: 36px; font-weight: bold; }
    
    .filter-bar { margin-bottom: 16px; display: flex; gap: 12px; align-items: center; }
    .filter-bar select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .tag-success { background: #f6ffed; color: #52c41a; }
    .tag-danger { background: #fff2f0; color: #ff4d4f; }
    .btn-sm { padding: 6px 16px; font-size: 13px; width: auto; }
    .loading { text-align: center; color: #999; padding: 40px; }
  </style>
</head>
<body>
  <div id="app">
    <!-- 登录页 -->
    <div v-if="!isLoggedIn" class="login-container">
      <div class="login-box">
        <h2>教务管理系统</h2>
        <div class="form-group">
          <label>学号</label>
          <input type="text" v-model="loginForm.student_id" placeholder="请输入学号 (测试: 2024001)" @keyup.enter="handleLogin">
        </div>
        <div class="form-group">
          <label>密码</label>
          <input type="password" v-model="loginForm.password" placeholder="请输入密码 (测试: 123456)" @keyup.enter="handleLogin">
        </div>
        <button class="btn btn-primary" @click="handleLogin" :disabled="isLoading">
          {{ isLoading ? '登录中...' : '登 录' }}
        </button>
        <div v-if="loginError" class="error-msg">{{ loginError }}</div>
      </div>
    </div>
    
    <!-- 主界面 -->
    <div v-else class="main-layout">
      <div class="sidebar">
        <h3>教务系统</h3>
        <ul class="nav-menu">
          <li :class="{ active: currentView === 'profile' }" @click="switchView('profile')">个人信息</li>
          <li :class="{ active: currentView === 'grades' }" @click="switchView('grades')">我的成绩</li>
          <li :class="{ active: currentView === 'gpa' }" @click="switchView('gpa')">绩点查询</li>
          <li :class="{ active: currentView === 'courses' }" @click="switchView('courses')">课程选择</li>
        </ul>
        <div class="logout-btn" @click="handleLogout">退出登录</div>
      </div>
      
      <div class="content">
        <!-- 个人信息 -->
        <template v-if="currentView === 'profile'">
          <div class="content-header"><h2>个人信息</h2></div>
          <div class="content-body">
            <div v-if="isLoading" class="loading">加载中...</div>
            <div v-else class="profile-card">
              <div class="profile-item"><label>学号</label><span>{{ profile.student_id || '-' }}</span></div>
              <div class="profile-item"><label>姓名</label><span>{{ profile.name || '-' }}</span></div>
              <div class="profile-item"><label>班级</label><span>{{ profile.class_name || '-' }}</span></div>
              <div class="profile-item"><label>手机</label><span>{{ profile.phone || '未填写' }}</span></div>
              <div class="profile-item highlight"><label>已修学分</label><span>{{ profile.total_credit || 0 }}</span></div>
              <div class="profile-item highlight"><label>总绩点 GPA</label><span>{{ profile.gpa || '0.00' }}</span></div>
            </div>
          </div>
        </template>
        
        <!-- 我的成绩 -->
        <template v-if="currentView === 'grades'">
          <div class="content-header"><h2>我的成绩</h2></div>
          <div class="content-body">
            <div v-if="isLoading" class="loading">加载中...</div>
            <template v-else>
              <div v-for="(courses, semester) in grades" :key="semester" class="semester-group">
                <div class="semester-title">{{ semester }}</div>
                <table class="data-table">
                  <thead>
                    <tr><th>课程号</th><th>课程名</th><th>学分</th><th>平时</th><th>期末</th><th>总评</th><th>绩点</th></tr>
                  </thead>
                  <tbody>
                    <tr v-for="c in courses" :key="c.course_id">
                      <td>{{ c.course_id }}</td><td>{{ c.course_name }}</td><td>{{ c.credit }}</td>
                      <td>{{ c.usual_score }}</td><td>{{ c.final_score }}</td><td>{{ c.total_score }}</td><td>{{ c.grade_point }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div v-if="Object.keys(grades).length === 0" class="loading">暂无成绩记录</div>
            </template>
          </div>
        </template>
        
        <!-- 绩点查询 -->
        <template v-if="currentView === 'gpa'">
          <div class="content-header"><h2>绩点查询</h2></div>
          <div class="content-body">
            <div v-if="isLoading" class="loading">加载中...</div>
            <template v-else>
              <div class="gpa-summary">
                <div class="gpa-card"><h4>总绩点 GPA</h4><div class="value">{{ gpaData.total_gpa }}</div></div>
                <div class="gpa-card" style="background: linear-gradient(135deg, #722ed1 0%, #eb2f96 100%);"><h4>总学分</h4><div class="value">{{ gpaData.total_credit }}</div></div>
              </div>
              <h4 style="margin-bottom: 16px; color: #333;">各学期绩点明细</h4>
              <table class="data-table">
                <thead><tr><th>学期</th><th>学期学分</th><th>学期绩点</th></tr></thead>
                <tbody>
                  <tr v-for="s in gpaData.semester_details" :key="s.semester">
                    <td>{{ s.semester }}</td><td>{{ s.semester_credit }}</td><td>{{ s.semester_gpa }}</td>
                  </tr>
                </tbody>
              </table>
              <div v-if="!gpaData.semester_details || gpaData.semester_details.length === 0" class="loading">暂无绩点记录</div>
            </template>
          </div>
        </template>
        
        <!-- 课程选择 -->
        <template v-if="currentView === 'courses'">
          <div class="content-header"><h2>课程选择</h2></div>
          <div class="content-body">
            <div class="filter-bar">
              <span>学期筛选：</span>
              <select v-model="semesterFilter" @change="loadCourses">
                <option value="">全部学期</option>
                <option v-for="s in semesters" :key="s" :value="s">{{ s }}</option>
              </select>
            </div>
            <div v-if="isLoading" class="loading">加载中...</div>
            <table v-else class="data-table">
              <thead><tr><th>课程号</th><th>课程名</th><th>教师</th><th>学分</th><th>学期</th><th>容量</th><th>已选/剩余</th><th>操作</th></tr></thead>
              <tbody>
                <tr v-for="c in courses" :key="c.course_id">
                  <td>{{ c.course_id }}</td><td>{{ c.course_name }}</td><td>{{ c.teacher }}</td><td>{{ c.credit }}</td><td>{{ c.semester }}</td><td>{{ c.capacity }}</td>
                  <td><span>{{ c.enrolled }} / </span><span :class="c.remaining > 0 ? 'tag tag-success' : 'tag tag-danger'">{{ c.remaining > 0 ? c.remaining : '已满' }}</span></td>
                  <td><button class="btn btn-primary btn-sm" @click="selectCourse(c.course_id)" :disabled="c.remaining <= 0">{{ c.remaining > 0 ? '选课' : '已满' }}</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </template>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost/edu_api';
    
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    
    createApp({
      setup() {
        const token = ref(localStorage.getItem('edu_token') || '');
        const user = ref(JSON.parse(localStorage.getItem('edu_user') || '{}'));
        const loginForm = reactive({ student_id: '', password: '' });
        const loginError = ref('');
        const isLoading = ref(false);
        const currentView = ref('profile');
        
        const profile = ref({});
        const grades = ref({});
        const gpaData = ref({ total_gpa: '0.00', total_credit: 0, semester_details: [] });
        const courses = ref([]);
        const semesters = ref(['2025Spring', '2024Fall', '2024Spring']);
        const semesterFilter = ref('');
        
        const isLoggedIn = computed(() => !!token.value && !!user.value.student_id);
        
        // 创建 axios 实例
        const api = axios.create({ 
          baseURL: API_BASE,
          timeout: 10000,
          headers: { 'Content-Type': 'application/json' }
        });
        
        api.interceptors.request.use(config => {
          if (token.value) {
            config.headers.Authorization = 'Bearer ' + token.value;
          }
          return config;
        });
        
        const handleLogin = async () => {
          if (!loginForm.student_id || !loginForm.password) {
            loginError.value = '请输入学号和密码';
            return;
          }
          
          loginError.value = '';
          isLoading.value = true;
          
          try {
            const res = await api.post('/login', {
              student_id: loginForm.student_id,
              password: loginForm.password
            });
            
            if (res.data && res.data.code === 0) {
              token.value = res.data.data.token;
              user.value = res.data.data.user;
              localStorage.setItem('edu_token', token.value);
              localStorage.setItem('edu_user', JSON.stringify(user.value));
              await loadProfile();
            } else {
              loginError.value = res.data?.msg || '登录失败';
            }
          } catch (e) {
            if (e.response) {
              loginError.value = e.response.data?.msg || '服务器错误: ' + e.response.status;
            } else if (e.request) {
              loginError.value = '无法连接服务器，请检查API地址: ' + API_BASE;
            } else {
              loginError.value = '请求错误: ' + e.message;
            }
          } finally {
            isLoading.value = false;
          }
        };
        
        const handleLogout = () => {
          token.value = '';
          user.value = {};
          localStorage.removeItem('edu_token');
          localStorage.removeItem('edu_user');
        };
        
        const switchView = (view) => {
          currentView.value = view;
          if (view === 'profile') loadProfile();
          else if (view === 'grades') loadGrades();
          else if (view === 'gpa') loadGpa();
          else if (view === 'courses') loadCourses();
        };
        
        const loadProfile = async () => {
          if (!user.value.student_id) return;
          isLoading.value = true;
          try {
            const res = await api.get('/student/' + user.value.student_id + '/profile');
            if (res.data && res.data.code === 0) profile.value = res.data.data;
          } catch (e) { console.error('loadProfile error:', e); }
          finally { isLoading.value = false; }
        };
        
        const loadGrades = async () => {
          if (!user.value.student_id) return;
          isLoading.value = true;
          try {
            const res = await api.get('/student/' + user.value.student_id + '/grades');
            if (res.data && res.data.code === 0) grades.value = res.data.data;
          } catch (e) { console.error('loadGrades error:', e); }
          finally { isLoading.value = false; }
        };
        
        const loadGpa = async () => {
          if (!user.value.student_id) return;
          isLoading.value = true;
          try {
            const res = await api.get('/student/' + user.value.student_id + '/gpa');
            if (res.data && res.data.code === 0) gpaData.value = res.data.data;
          } catch (e) { console.error('loadGpa error:', e); }
          finally { isLoading.value = false; }
        };
        
        const loadCourses = async () => {
          isLoading.value = true;
          try {
            const url = semesterFilter.value ? '/courses?semester=' + semesterFilter.value : '/courses';
            const res = await api.get(url);
            if (res.data && res.data.code === 0) courses.value = res.data.data;
          } catch (e) { console.error('loadCourses error:', e); }
          finally { isLoading.value = false; }
        };
        
        const selectCourse = async (courseId) => {
          try {
            const res = await api.post('/select', {
              student_id: user.value.student_id,
              course_id: courseId
            });
            if (res.data && res.data.code === 0) {
              alert('选课成功');
              loadCourses();
            } else {
              alert(res.data?.msg || '选课失败');
            }
          } catch (e) {
            alert(e.response?.data?.msg || '选课失败');
          }
        };
        
        onMounted(() => {
          if (isLoggedIn.value) loadProfile();
        });
        
        return {
          isLoggedIn, token, user, loginForm, loginError, isLoading, currentView,
          profile, grades, gpaData, courses, semesters, semesterFilter,
          handleLogin, handleLogout, switchView, loadCourses, selectCourse
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
